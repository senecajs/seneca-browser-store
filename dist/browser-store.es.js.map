{"version":3,"file":"browser-store.es.js","sources":["../src/browser-store.ts"],"sourcesContent":["/* Copyright (c) 2023 Richard Rodger and other contributors, MIT License */\n\nfunction BrowserStore(this: any, options: any) {\n  let seneca: any = this\n\n  let init = seneca.export('entity/init')\n\n  let ohr = options.handleResponse\n  let handleResponse = ['save', 'load', 'list', 'remove'].reduce(\n    (a: any, n) => ((a[n] = ohr[n] || ohr.any), a),\n    {},\n  )\n\n  const msglog: {\n    msg: any\n    meta: any\n    start: number\n    ctx?: any\n    apimsg?: any\n    res?: any\n    err?: any\n    apimeta?: any\n    apiend?: number\n    end?: number\n  }[] = []\n\n  function makeApiMsg(msg: any, ctx: any, options: any) {\n    let apimsg: any = {}\n    let apimsgtm = options.apimsg\n\n    for (let pn in apimsgtm) {\n      let pv = apimsgtm[pn]\n      if ('function' === typeof pv) {\n        apimsg[pn] = pv(msg, ctx, options)\n      } else {\n        apimsg[pn] = JSON.parse(JSON.stringify(pv))\n      }\n    }\n\n    return apimsg\n  }\n\n  let store = {\n    name: 'BrowserStore',\n\n    save: function (this: any, msg: any, reply: any, _meta: any) {\n      let logn = options.debug && logstart(arguments)\n      let ctx = options.prepareCtx(msg)\n      let apimsg = makeApiMsg(msg, ctx, options)\n\n      logn && (logn.ctx = ctx) && (logn.apimsg = apimsg)\n      this.act(\n        apimsg,\n        function save_result(this: any, err: Error, res: any, apimeta: any) {\n          logn &&\n            (logn.apiend = Date.now()) &&\n            (logn.err = err) &&\n            (logn.res = res) &&\n            (logn.apimeta = apimeta)\n          return handleResponse.save(this, ctx, reply, err, res, apimeta, logn)\n        },\n      )\n    },\n\n    load: function (this: any, msg: any, reply: any, _meta: any) {\n      let logn = options.debug && logstart(arguments)\n      let ctx = options.prepareCtx(msg)\n      let apimsg = makeApiMsg(msg, ctx, options)\n\n      logn && (logn.ctx = ctx) && (logn.apimsg = apimsg)\n      this.act(\n        apimsg,\n        function load_result(this: any, err: Error, res: any, apimeta: any) {\n          logn && logres(logn, arguments)\n          return handleResponse.load(this, ctx, reply, err, res, apimeta, logn)\n        },\n      )\n    },\n\n    list: function (this: any, msg: any, reply: any, _meta: any) {\n      let logn = options.debug && logstart(arguments)\n      let ctx = options.prepareCtx(msg)\n      let apimsg = makeApiMsg(msg, ctx, options)\n\n      logn && (logn.ctx = ctx) && (logn.apimsg = apimsg)\n      this.act(\n        apimsg,\n        function list_result(this: any, err: Error, res: any, apimeta: any) {\n          logn && logres(logn, arguments)\n          return handleResponse.list(this, ctx, reply, err, res, apimeta, logn)\n        },\n      )\n    },\n\n    remove: function (this: any, msg: any, reply: any, _meta: any) {\n      let logn = options.debug && logstart(arguments)\n      let ctx = options.prepareCtx(msg)\n      let apimsg = makeApiMsg(msg, ctx, options)\n\n      logn && (logn.ctx = ctx) && (logn.apimsg = apimsg)\n      this.act(\n        apimsg,\n        function remove_result(this: any, err: Error, res: any, apimeta: any) {\n          logn && logres(logn, arguments)\n          return handleResponse.remove(\n            this,\n            ctx,\n            reply,\n            err,\n            res,\n            apimeta,\n            logn,\n          )\n        },\n      )\n    },\n\n    close: function (this: any, _msg: any, reply: any) {\n      reply()\n    },\n\n    native: function (this: any, _msg: any, reply: any) {\n      reply()\n    },\n  }\n\n  let meta = init(seneca, options, store)\n\n  function logstart(args: any) {\n    let logn = options.debug && {\n      msg: args[0],\n      meta: args[2],\n      start: Date.now(),\n    }\n    logn && msglog.push(logn)\n    return logn\n  }\n\n  function logres(logn: any, args: any) {\n    logn.apiend = Date.now()\n    logn.err = args[0]\n    logn.res = args[1]\n    logn.apimeta = args[2]\n    return logn\n  }\n\n  return {\n    name: store.name,\n    tag: meta.tag,\n    exports: {\n      makeApiMsg,\n      msglog,\n    },\n  }\n}\n\nBrowserStore.defaults = {\n  debug: false,\n\n  apimsg: {\n    aim: 'req',\n    on: 'entity',\n    debounce$: true,\n    q: (msg: any, _ctx: any) => msg.q,\n    ent: (msg: any, _ctx: any) => msg.ent,\n    cmd: (_msg: any, ctx: any) => ctx.cmd,\n    canon: (msg: any, _ctx: any) => (msg.ent || msg.qent).entity$,\n    store: (_msg: any, ctx: any) => ctx.store,\n  },\n\n  prepareCtx: (msg: any, ctx: any) => {\n    ctx = ctx || {}\n\n    let q = msg.q\n    ctx.store = false !== q.store$\n    delete q.store$\n\n    ctx.cmd = msg.cmd\n    ctx.canon = (msg.ent || msg.qent).entity$\n\n    return ctx\n  },\n\n  handleResponse: {\n    any: function (\n      _seneca: any,\n      ctx: any,\n      reply: any,\n      err: Error,\n      res: any,\n      _apimeta: any,\n      logn: any,\n    ) {\n      console.log('BS RES', err, res)\n\n\n      logn && (logn.end = Date.now())\n\n      if (err) {\n        reply(err)\n      }\n\n      if (res) {\n        if (res.ok) {\n          reply(res.ent)\n        }\n        else {\n          let err = res.err\n          err = err || new Error(`BrowserStore: ${ctx.cmd} ${ctx.canon}: unknown error`)\n          reply(err)\n        }\n      }\n    },\n\n    list: function (\n      seneca: any,\n      ctx: any,\n      reply: any,\n      err: Error,\n      res: any,\n      _apimeta: any,\n      logn: any,\n    ) {\n      logn && (logn.end = Date.now())\n      if (err) reply(err)\n\n      if (res && res.ok && res.list) {\n        let list = res.list.map((item: any) =>\n          seneca.entity(ctx.canon).data$(item),\n        )\n        logn && (logn.end = Date.now())\n        reply(list)\n      } else {\n        reply(\n          (res && res.err) ||\n          new Error(\n            `BrowserStore: ${ctx.cmd} ${ctx.canon}: unknown list error`,\n          ),\n        )\n      }\n    },\n  },\n}\n\n// Prevent name mangling\nObject.defineProperty(BrowserStore, 'name', { value: 'BrowserStore' })\n\n\nexport default BrowserStore\n"],"names":["BrowserStore","options","seneca","init","ohr","handleResponse","a","n","msglog","makeApiMsg","msg","ctx","apimsg","apimsgtm","pn","pv","store","reply","_meta","logn","logstart","err","res","apimeta","logres","_msg","meta","args","_ctx","q","_seneca","_apimeta","list","item"],"mappings":"AAEA,SAASA,EAAwBC,GAAc;AAC7C,MAAIC,IAAc,MAEdC,IAAOD,EAAO,OAAO,aAAa,GAElCE,IAAMH,EAAQ,gBACdI,IAAiB,CAAC,QAAQ,QAAQ,QAAQ,QAAQ,EAAE;AAAA,IACtD,CAACC,GAAQC,OAAQD,EAAEC,CAAC,IAAIH,EAAIG,CAAC,KAAKH,EAAI,KAAME;AAAA,IAC5C,CAAC;AAAA,EAAA;AAGH,QAAME,IAWA,CAAA;AAEG,WAAAC,EAAWC,GAAUC,GAAUV,GAAc;AACpD,QAAIW,IAAc,CAAA,GACdC,IAAWZ,EAAQ;AAEvB,aAASa,KAAMD,GAAU;AACnB,UAAAE,IAAKF,EAASC,CAAE;AAChB,MAAe,OAAOC,KAAtB,aACFH,EAAOE,CAAE,IAAIC,EAAGL,GAAKC,GAAKV,CAAO,IAEjCW,EAAOE,CAAE,IAAI,KAAK,MAAM,KAAK,UAAUC,CAAE,CAAC;AAAA,IAE9C;AAEO,WAAAH;AAAA,EACT;AAEA,MAAII,IAAQ;AAAA,IACV,MAAM;AAAA,IAEN,MAAM,SAAqBN,GAAUO,GAAYC,GAAY;AAC3D,UAAIC,IAAOlB,EAAQ,SAASmB,EAAS,SAAS,GAC1CT,IAAMV,EAAQ,WAAWS,CAAG,GAC5BE,IAASH,EAAWC,GAAKC,GAAKV,CAAO;AAEzC,MAAAkB,MAASA,EAAK,MAAMR,OAASQ,EAAK,SAASP,IACtC,KAAA;AAAA,QACHA;AAAA,QACA,SAAgCS,GAAYC,GAAUC,GAAc;AAClE,iBAAAJ,MACGA,EAAK,SAAS,KAAK,IACnB,OAAAA,EAAK,MAAME,OACXF,EAAK,MAAMG,OACXH,EAAK,UAAUI,IACXlB,EAAe,KAAK,MAAMM,GAAKM,GAAOI,GAAKC,GAAKC,GAASJ,CAAI;AAAA,QACtE;AAAA,MAAA;AAAA,IAEJ;AAAA,IAEA,MAAM,SAAqBT,GAAUO,GAAYC,GAAY;AAC3D,UAAIC,IAAOlB,EAAQ,SAASmB,EAAS,SAAS,GAC1CT,IAAMV,EAAQ,WAAWS,CAAG,GAC5BE,IAASH,EAAWC,GAAKC,GAAKV,CAAO;AAEzC,MAAAkB,MAASA,EAAK,MAAMR,OAASQ,EAAK,SAASP,IACtC,KAAA;AAAA,QACHA;AAAA,QACA,SAAgCS,GAAYC,GAAUC,GAAc;AAC1D,iBAAAJ,KAAAK,EAAOL,GAAM,SAAS,GACvBd,EAAe,KAAK,MAAMM,GAAKM,GAAOI,GAAKC,GAAKC,GAASJ,CAAI;AAAA,QACtE;AAAA,MAAA;AAAA,IAEJ;AAAA,IAEA,MAAM,SAAqBT,GAAUO,GAAYC,GAAY;AAC3D,UAAIC,IAAOlB,EAAQ,SAASmB,EAAS,SAAS,GAC1CT,IAAMV,EAAQ,WAAWS,CAAG,GAC5BE,IAASH,EAAWC,GAAKC,GAAKV,CAAO;AAEzC,MAAAkB,MAASA,EAAK,MAAMR,OAASQ,EAAK,SAASP,IACtC,KAAA;AAAA,QACHA;AAAA,QACA,SAAgCS,GAAYC,GAAUC,GAAc;AAC1D,iBAAAJ,KAAAK,EAAOL,GAAM,SAAS,GACvBd,EAAe,KAAK,MAAMM,GAAKM,GAAOI,GAAKC,GAAKC,GAASJ,CAAI;AAAA,QACtE;AAAA,MAAA;AAAA,IAEJ;AAAA,IAEA,QAAQ,SAAqBT,GAAUO,GAAYC,GAAY;AAC7D,UAAIC,IAAOlB,EAAQ,SAASmB,EAAS,SAAS,GAC1CT,IAAMV,EAAQ,WAAWS,CAAG,GAC5BE,IAASH,EAAWC,GAAKC,GAAKV,CAAO;AAEzC,MAAAkB,MAASA,EAAK,MAAMR,OAASQ,EAAK,SAASP,IACtC,KAAA;AAAA,QACHA;AAAA,QACA,SAAkCS,GAAYC,GAAUC,GAAc;AAC5D,iBAAAJ,KAAAK,EAAOL,GAAM,SAAS,GACvBd,EAAe;AAAA,YACpB;AAAA,YACAM;AAAA,YACAM;AAAA,YACAI;AAAA,YACAC;AAAA,YACAC;AAAA,YACAJ;AAAA,UAAA;AAAA,QAEJ;AAAA,MAAA;AAAA,IAEJ;AAAA,IAEA,OAAO,SAAqBM,GAAWR,GAAY;AAC3C,MAAAA;IACR;AAAA,IAEA,QAAQ,SAAqBQ,GAAWR,GAAY;AAC5C,MAAAA;IACR;AAAA,EAAA,GAGES,IAAOvB,EAAKD,GAAQD,GAASe,CAAK;AAEtC,WAASI,EAASO,GAAW;AACvB,QAAAR,IAAOlB,EAAQ,SAAS;AAAA,MAC1B,KAAK0B,EAAK,CAAC;AAAA,MACX,MAAMA,EAAK,CAAC;AAAA,MACZ,OAAO,KAAK,IAAI;AAAA,IAAA;AAEV,WAAAR,KAAAX,EAAO,KAAKW,CAAI,GACjBA;AAAA,EACT;AAES,WAAAK,EAAOL,GAAWQ,GAAW;AAC/B,WAAAR,EAAA,SAAS,KAAK,OACdA,EAAA,MAAMQ,EAAK,CAAC,GACZR,EAAA,MAAMQ,EAAK,CAAC,GACZR,EAAA,UAAUQ,EAAK,CAAC,GACdR;AAAA,EACT;AAEO,SAAA;AAAA,IACL,MAAMH,EAAM;AAAA,IACZ,KAAKU,EAAK;AAAA,IACV,SAAS;AAAA,MACP,YAAAjB;AAAA,MACA,QAAAD;AAAA,IACF;AAAA,EAAA;AAEJ;AAEAR,EAAa,WAAW;AAAA,EACtB,OAAO;AAAA,EAEP,QAAQ;AAAA,IACN,KAAK;AAAA,IACL,IAAI;AAAA,IACJ,WAAW;AAAA,IACX,GAAG,CAACU,GAAUkB,MAAclB,EAAI;AAAA,IAChC,KAAK,CAACA,GAAUkB,MAAclB,EAAI;AAAA,IAClC,KAAK,CAACe,GAAWd,MAAaA,EAAI;AAAA,IAClC,OAAO,CAACD,GAAUkB,OAAelB,EAAI,OAAOA,EAAI,MAAM;AAAA,IACtD,OAAO,CAACe,GAAWd,MAAaA,EAAI;AAAA,EACtC;AAAA,EAEA,YAAY,CAACD,GAAUC,MAAa;AAClC,IAAAA,IAAMA,KAAO;AAEb,QAAIkB,IAAInB,EAAI;AACR,WAAAC,EAAA,QAAkBkB,EAAE,WAAZ,IACZ,OAAOA,EAAE,QAETlB,EAAI,MAAMD,EAAI,KACdC,EAAI,SAASD,EAAI,OAAOA,EAAI,MAAM,SAE3BC;AAAA,EACT;AAAA,EAEA,gBAAgB;AAAA,IACd,KAAK,SACHmB,GACAnB,GACAM,GACAI,GACAC,GACAS,GACAZ,GACA;AAUA,UATQ,QAAA,IAAI,UAAUE,GAAKC,CAAG,GAGrBH,MAAAA,EAAK,MAAM,KAAK,IAAI,IAEzBE,KACFJ,EAAMI,CAAG,GAGPC;AACF,YAAIA,EAAI;AACN,UAAAL,EAAMK,EAAI,GAAG;AAAA,aAEV;AACH,cAAID,IAAMC,EAAI;AACdD,UAAAA,IAAMA,KAAO,IAAI,MAAM,iBAAiBV,EAAI,GAAG,IAAIA,EAAI,KAAK,iBAAiB,GAC7EM,EAAMI,CAAG;AAAA,QACX;AAAA,IAEJ;AAAA,IAEA,MAAM,SACJnB,GACAS,GACAM,GACAI,GACAC,GACAS,GACAZ,GACA;AAIA,UAHSA,MAAAA,EAAK,MAAM,KAAK,IAAI,IACzBE,KAAKJ,EAAMI,CAAG,GAEdC,KAAOA,EAAI,MAAMA,EAAI,MAAM;AACzB,YAAAU,IAAOV,EAAI,KAAK;AAAA,UAAI,CAACW,MACvB/B,EAAO,OAAOS,EAAI,KAAK,EAAE,MAAMsB,CAAI;AAAA,QAAA;AAE5B,QAAAd,MAAAA,EAAK,MAAM,KAAK,IAAI,IAC7BF,EAAMe,CAAI;AAAA,MAAA;AAEV,QAAAf;AAAA,UACGK,KAAOA,EAAI,OACZ,IAAI;AAAA,YACF,iBAAiBX,EAAI,GAAG,IAAIA,EAAI,KAAK;AAAA,UACvC;AAAA,QAAA;AAAA,IAGN;AAAA,EACF;AACF;AAGA,OAAO,eAAeX,GAAc,QAAQ,EAAE,OAAO,gBAAgB;"}