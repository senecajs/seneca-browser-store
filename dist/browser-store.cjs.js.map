{"version":3,"file":"browser-store.cjs.js","sources":["../src/browser-store.ts"],"sourcesContent":["/* Copyright (c) 2023-2024 Richard Rodger and other contributors, MIT License */\n\nconsole.log('BrowserStore 2')\n\nfunction BrowserStore(this: any, options: any) {\n  let seneca: any = this\n\n  let init = seneca.export('entity/init')\n\n  let ohr = options.handleResponse\n  let handleResponse = ['save', 'load', 'list', 'remove'].reduce(\n    (a: any, n) => ((a[n] = ohr[n] || ohr.any), a),\n    {},\n  )\n\n  const msglog: {\n    msg: any\n    meta: any\n    start: number\n    ctx?: any\n    apimsg?: any\n    res?: any\n    err?: any\n    apimeta?: any\n    apiend?: number\n    end?: number\n  }[] = []\n\n  function makeApiMsg(msg: any, ctx: any, options: any) {\n    let apimsg: any = {}\n    let apimsgtm = options.apimsg\n\n    for (let pn in apimsgtm) {\n      let pv = apimsgtm[pn]\n      if ('function' === typeof pv) {\n        apimsg[pn] = pv(msg, ctx, options)\n      } else {\n        apimsg[pn] = JSON.parse(JSON.stringify(pv))\n      }\n    }\n\n    return apimsg\n  }\n\n  let store = {\n    name: 'BrowserStore',\n\n    save: function (this: any, msg: any, reply: any, _meta: any) {\n      let logn = options.debug && logstart(arguments)\n      let ctx = options.prepareCtx(msg)\n      let apimsg = makeApiMsg(msg, ctx, options)\n\n      // console.log('SAVE', msg, apimsg)\n\n      // Provide a new entity with no id for saving later.\n      if (\n        true === apimsg.q.add$ &&\n        null == apimsg.ent.id &&\n        null == apimsg.ent.id$\n      ) {\n        return handleResponse.save(\n          this,\n          ctx,\n          reply,\n          null,\n          { ok: true, item: apimsg.ent },\n          apimsg,\n          meta,\n          logn,\n        )\n      }\n\n      logn && logreq(logn, ctx, apimsg)\n      this.act(\n        apimsg,\n        function save_result(this: any, err: Error, res: any, apimeta: any) {\n          logn && logres(logn, arguments)\n          return handleResponse.save(\n            this,\n            ctx,\n            reply,\n            err,\n            res,\n            apimsg,\n            apimeta,\n            logn,\n          )\n        },\n      )\n    },\n\n    load: function (this: any, msg: any, reply: any, meta: any) {\n      let logn = options.debug && logstart(arguments)\n      let ctx = options.prepareCtx(msg)\n      let apimsg = makeApiMsg(msg, ctx, options)\n\n      logn && logreq(logn, ctx, apimsg)\n      this.act(\n        apimsg,\n        function load_result(this: any, err: Error, res: any, apimeta: any) {\n          logn && logres(logn, arguments)\n          return handleResponse.load(\n            this,\n            ctx,\n            reply,\n            err,\n            res,\n            apimsg,\n            apimeta,\n            logn,\n          )\n        },\n      )\n    },\n\n    list: function (this: any, msg: any, reply: any, _meta: any) {\n      let logn = options.debug && logstart(arguments)\n      let ctx = options.prepareCtx(msg)\n      let apimsg = makeApiMsg(msg, ctx, options)\n\n      logn && logreq(logn, ctx, apimsg)\n      this.act(\n        apimsg,\n        function list_result(this: any, err: Error, res: any, apimeta: any) {\n          logn && logres(logn, arguments)\n          return handleResponse.list(\n            this,\n            ctx,\n            reply,\n            err,\n            res,\n            apimsg,\n            apimeta,\n            logn,\n          )\n        },\n      )\n    },\n\n    remove: function (this: any, msg: any, reply: any, _meta: any) {\n      let logn = options.debug && logstart(arguments)\n      let ctx = options.prepareCtx(msg)\n      let apimsg = makeApiMsg(msg, ctx, options)\n\n      logn && logreq(logn, ctx, apimsg)\n      this.act(\n        apimsg,\n        function remove_result(this: any, err: Error, res: any, apimeta: any) {\n          logn && logres(logn, arguments)\n          return handleResponse.remove(\n            this,\n            ctx,\n            reply,\n            err,\n            res,\n            apimsg,\n            apimeta,\n            logn,\n          )\n        },\n      )\n    },\n\n    close: function (this: any, _msg: any, reply: any) {\n      reply()\n    },\n\n    native: function (this: any, _msg: any, reply: any) {\n      reply()\n    },\n  }\n\n  let meta = init(seneca, options, store)\n\n  function logstart(args: any) {\n    let logn = options.debug && {\n      msg: args[0],\n      meta: args[2],\n      start: Date.now(),\n    }\n    logn && msglog.push(logn)\n    return logn\n  }\n\n  function logreq(logn: any, ctx: any, apimsg: any) {\n    logn.apistart = Date.now()\n    logn.ctx = ctx\n    logn.apimsg = apimsg\n    return logn\n  }\n\n  function logres(logn: any, args: any) {\n    logn.apiend = Date.now()\n    logn.err = args[0]\n    logn.res = args[1]\n    logn.apimeta = args[2]\n    return logn\n  }\n\n  return {\n    name: store.name,\n    tag: meta.tag,\n    exports: {\n      makeApiMsg,\n      msglog,\n    },\n  }\n}\n\nfunction canonStr(seneca: any, ctx: any) {\n  return seneca.entity(ctx.zone, ctx.base, ctx.name).canon$()\n}\n\nBrowserStore.defaults = {\n  debug: false,\n\n  apimsg: {\n    aim: 'req',\n    on: 'entity',\n    debounce$: true,\n    q: (msg: any, _ctx: any) => msg.q,\n    ent: (msg: any, _ctx: any) => msg.ent,\n    // cmd: (_msg: any, ctx: any) => ctx.cmd,\n    save: (_msg: any, ctx: any) => ('save' === ctx.cmd ? 'entity' : undefined),\n    load: (_msg: any, ctx: any) => ('load' === ctx.cmd ? 'entity' : undefined),\n    list: (_msg: any, ctx: any) => ('list' === ctx.cmd ? 'entity' : undefined),\n    remove: (_msg: any, ctx: any) =>\n      'remove' === ctx.cmd ? 'entity' : undefined,\n    store: (_msg: any, ctx: any) => ctx.store,\n    name: (_msg: any, ctx: any) => ctx.name,\n    base: (_msg: any, ctx: any) => ctx.base,\n    zone: (_msg: any, ctx: any) => ctx.zone,\n  },\n\n  prepareCtx: (msg: any, ctx: any) => {\n    ctx = ctx || {}\n\n    let q = msg.q\n    ctx.store = false !== q.store$\n    delete q.store$\n\n    ctx.cmd = msg.cmd\n\n    let ent = msg.ent || msg.qent\n\n    if (ent) {\n      if (ent.canon$) {\n        Object.assign(ctx, ent.canon$({ object: true }))\n      } else if (ent.entity$) {\n        let parts = ent.entity$.split('/')\n        Object.assign(ctx, {\n          zone: '-' === parts[0] ? null : parts[0],\n          base: '-' === parts[1] ? null : parts[1],\n          name: '-' === parts[2] ? null : parts[2],\n        })\n      }\n    }\n\n    return ctx\n  },\n\n  handleResponse: {\n    any: function (\n      seneca: any,\n      ctx: any,\n      reply: any,\n      err: Error,\n      res: any,\n      apimsg: any,\n      _apimeta: any,\n      logn: any,\n    ) {\n      logn && (logn.end = Date.now())\n\n      if (err) {\n        return reply(err)\n      }\n\n      // TODO: debounce response could be empty object - review\n      if ('entity' === apimsg.load && (null == res || null == res.ok)) {\n        return reply(null)\n      }\n\n      if (res && res.ok && res.item) {\n        let canon = [ctx.zone, ctx.base, ctx.name]\n        let ent = seneca.entity(...canon)\n\n        // TODO: FIX entity make$() should already have canon\n        return reply(ent.clone$().data$(res.item))\n      } else {\n        let err = res && res.err\n        err =\n          err ||\n          new Error(\n            `BrowserStore: ${ctx.cmd} ${canonStr(seneca, ctx)}: unknown error`,\n          )\n        return reply(err)\n      }\n    },\n\n    list: function (\n      seneca: any,\n      ctx: any,\n      reply: any,\n      err: Error,\n      res: any,\n      _apimsg: any,\n      _apimeta: any,\n      logn: any,\n    ) {\n      logn && (logn.end = Date.now())\n\n      if (err) {\n        reply(err)\n      }\n\n      if (res && res.ok && res.list) {\n        let canon = [ctx.zone, ctx.base, ctx.name]\n        let ent = seneca.entity(...canon)\n\n        let list = res.list.map((item: any) => ent.clone$().data$(item))\n        logn && (logn.end = Date.now())\n        reply(list)\n      } else {\n        let err = res && res.err\n        err =\n          err ||\n          new Error(\n            `BrowserStore: ${ctx.cmd} ${canonStr(\n              seneca,\n              ctx,\n            )}: unknown list error`,\n          )\n        reply(err)\n      }\n    },\n  },\n}\n\n// Prevent name mangling\nObject.defineProperty(BrowserStore, 'name', { value: 'BrowserStore' })\n\nexport default BrowserStore\n"],"names":["BrowserStore","options","seneca","init","ohr","handleResponse","a","n","msglog","makeApiMsg","msg","ctx","apimsg","apimsgtm","pn","pv","store","reply","_meta","logn","logstart","meta","logreq","err","res","apimeta","logres","_msg","args","canonStr","_ctx","q","ent","parts","_apimeta","canon","_apimsg","list","item"],"mappings":"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"}