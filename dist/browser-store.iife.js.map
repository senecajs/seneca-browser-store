{"version":3,"file":"browser-store.iife.js","sources":["../src/browser-store.ts"],"sourcesContent":["/* Copyright (c) 2023 Richard Rodger and other contributors, MIT License */\n\nfunction BrowserStore(this: any, options: any) {\n  let seneca: any = this\n\n  let init = seneca.export('entity/init')\n\n  let ohr = options.handleResponse\n  let handleResponse = ['save', 'load', 'list', 'remove'].reduce(\n    (a: any, n) => ((a[n] = ohr[n] || ohr.any), a),\n    {},\n  )\n\n  const msglog: {\n    msg: any\n    meta: any\n    start: number\n    ctx?: any\n    apimsg?: any\n    res?: any\n    err?: any\n    apimeta?: any\n    apiend?: number\n    end?: number\n  }[] = []\n\n  function makeApiMsg(msg: any, ctx: any, options: any) {\n    let apimsg: any = {}\n    let apimsgtm = options.apimsg\n\n    for (let pn in apimsgtm) {\n      let pv = apimsgtm[pn]\n      if ('function' === typeof pv) {\n        apimsg[pn] = pv(msg, ctx, options)\n      } else {\n        apimsg[pn] = JSON.parse(JSON.stringify(pv))\n      }\n    }\n\n    return apimsg\n  }\n\n  let store = {\n    name: 'BrowserStore',\n\n    save: function (this: any, msg: any, reply: any, _meta: any) {\n      let logn = options.debug && logstart(arguments)\n      let ctx = options.prepareCtx(msg)\n      let apimsg = makeApiMsg(msg, ctx, options)\n\n      logn && (logn.ctx = ctx) && (logn.apimsg = apimsg)\n      this.act(\n        apimsg,\n        function save_result(this: any, err: Error, res: any, apimeta: any) {\n          logn &&\n            (logn.apiend = Date.now()) &&\n            (logn.err = err) &&\n            (logn.res = res) &&\n            (logn.apimeta = apimeta)\n          return handleResponse.save(this, ctx, reply, err, res, apimeta, logn)\n        },\n      )\n    },\n\n    load: function (this: any, msg: any, reply: any, _meta: any) {\n      let logn = options.debug && logstart(arguments)\n      let ctx = options.prepareCtx(msg)\n      let apimsg = makeApiMsg(msg, ctx, options)\n\n      logn && (logn.ctx = ctx) && (logn.apimsg = apimsg)\n      this.act(\n        apimsg,\n        function load_result(this: any, err: Error, res: any, apimeta: any) {\n          logn && logres(logn, arguments)\n          return handleResponse.load(this, ctx, reply, err, res, apimeta, logn)\n        },\n      )\n    },\n\n    list: function (this: any, msg: any, reply: any, _meta: any) {\n      let logn = options.debug && logstart(arguments)\n      let ctx = options.prepareCtx(msg)\n      let apimsg = makeApiMsg(msg, ctx, options)\n\n      logn && (logn.ctx = ctx) && (logn.apimsg = apimsg)\n      this.act(\n        apimsg,\n        function list_result(this: any, err: Error, res: any, apimeta: any) {\n          logn && logres(logn, arguments)\n          return handleResponse.list(this, ctx, reply, err, res, apimeta, logn)\n        },\n      )\n    },\n\n    remove: function (this: any, msg: any, reply: any, _meta: any) {\n      let logn = options.debug && logstart(arguments)\n      let ctx = options.prepareCtx(msg)\n      let apimsg = makeApiMsg(msg, ctx, options)\n\n      logn && (logn.ctx = ctx) && (logn.apimsg = apimsg)\n      this.act(\n        apimsg,\n        function remove_result(this: any, err: Error, res: any, apimeta: any) {\n          logn && logres(logn, arguments)\n          return handleResponse.remove(\n            this,\n            ctx,\n            reply,\n            err,\n            res,\n            apimeta,\n            logn,\n          )\n        },\n      )\n    },\n\n    close: function (this: any, _msg: any, reply: any) {\n      reply()\n    },\n\n    native: function (this: any, _msg: any, reply: any) {\n      reply()\n    },\n  }\n\n  let meta = init(seneca, options, store)\n\n  function logstart(args: any) {\n    let logn = options.debug && {\n      msg: args[0],\n      meta: args[2],\n      start: Date.now(),\n    }\n    logn && msglog.push(logn)\n    return logn\n  }\n\n  function logres(logn: any, args: any) {\n    logn.apiend = Date.now()\n    logn.err = args[0]\n    logn.res = args[1]\n    logn.apimeta = args[2]\n    return logn\n  }\n\n  return {\n    name: store.name,\n    tag: meta.tag,\n    exports: {\n      makeApiMsg,\n      msglog,\n    },\n  }\n}\n\nBrowserStore.defaults = {\n  debug: false,\n\n  apimsg: {\n    aim: 'req',\n    on: 'entity',\n    debounce$: true,\n    q: (msg: any, _ctx: any) => msg.q,\n    ent: (msg: any, _ctx: any) => msg.ent,\n    cmd: (_msg: any, ctx: any) => ctx.cmd,\n    canon: (msg: any, _ctx: any) => (msg.ent || msg.qent).entity$,\n    store: (_msg: any, ctx: any) => ctx.store,\n  },\n\n  prepareCtx: (msg: any, ctx: any) => {\n    ctx = ctx || {}\n\n    let q = msg.q\n    ctx.store = false !== q.store$\n    delete q.store$\n\n    ctx.cmd = msg.cmd\n    ctx.canon = (msg.ent || msg.qent).entity$\n\n    return ctx\n  },\n\n  handleResponse: {\n    any: function (\n      _seneca: any,\n      ctx: any,\n      reply: any,\n      err: Error,\n      res: any,\n      _apimeta: any,\n      logn: any,\n    ) {\n      console.log('BS RES', err, res)\n\n\n      logn && (logn.end = Date.now())\n\n      if (err) {\n        reply(err)\n      }\n\n      if (res) {\n        if (res.ok) {\n          reply(res.ent)\n        }\n        else {\n          let err = res.err\n          err = err || new Error(`BrowserStore: ${ctx.cmd} ${ctx.canon}: unknown error`)\n          reply(err)\n        }\n      }\n    },\n\n    list: function (\n      seneca: any,\n      ctx: any,\n      reply: any,\n      err: Error,\n      res: any,\n      _apimeta: any,\n      logn: any,\n    ) {\n      logn && (logn.end = Date.now())\n      if (err) reply(err)\n\n      if (res && res.ok && res.list) {\n        let list = res.list.map((item: any) =>\n          seneca.entity(ctx.canon).data$(item),\n        )\n        logn && (logn.end = Date.now())\n        reply(list)\n      } else {\n        reply(\n          (res && res.err) ||\n          new Error(\n            `BrowserStore: ${ctx.cmd} ${ctx.canon}: unknown list error`,\n          ),\n        )\n      }\n    },\n  },\n}\n\n// Prevent name mangling\nObject.defineProperty(BrowserStore, 'name', { value: 'BrowserStore' })\n\n\nexport default BrowserStore\n"],"names":["BrowserStore","options","seneca","init","ohr","handleResponse","a","n","msglog","makeApiMsg","msg","ctx","apimsg","apimsgtm","pn","pv","store","reply","_meta","logn","logstart","err","res","apimeta","logres","_msg","meta","args","_ctx","q","_seneca","_apimeta","list","item"],"mappings":"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"}