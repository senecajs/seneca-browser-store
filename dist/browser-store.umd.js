(function(g,w){typeof exports=="object"&&typeof module<"u"?module.exports=w():typeof define=="function"&&define.amd?define(w):(g=typeof globalThis<"u"?globalThis:g||self,g.BrowserStore=w())})(this,function(){"use strict";console.log("BrowserStore 3");function g(t){let e=this,m=e.export("entity/init"),s=t.handleResponse,r=["save","load","list","remove"].reduce((n,i)=>(n[i]=s[i]||s.any,n),{});const y=[];function p(n,i,c){let a={},o=c.apimsg;for(let l in o){let _=o[l];typeof _=="function"?a[l]=_(n,i,c):a[l]=JSON.parse(JSON.stringify(_))}return a}let d={name:"BrowserStore",save:function(n,i,c){let a=t.debug&&f(arguments),o=t.prepareCtx(n),l=p(n,o,t);if(l.q.add$===!0&&l.ent.id==null&&l.ent.id$==null)return r.save(this,o,i,null,{ok:!0,item:l.ent},l,u,a);a&&$(a,o,l),this.act(l,function(v,h,b){return a&&S(a,arguments),r.save(this,o,i,v,h,l,b,a)})},load:function(n,i,c){let a=t.debug&&f(arguments),o=t.prepareCtx(n),l=p(n,o,t);a&&$(a,o,l),this.act(l,function(v,h,b){return a&&S(a,arguments),r.load(this,o,i,v,h,l,b,a)})},list:function(n,i,c){let a=t.debug&&f(arguments),o=t.prepareCtx(n),l=p(n,o,t);console.log("BS-list",l),a&&$(a,o,l),this.act(l,function(v,h,b){return a&&S(a,arguments),r.list(this,o,i,v,h,l,b,a)})},remove:function(n,i,c){let a=t.debug&&f(arguments),o=t.prepareCtx(n),l=p(n,o,t);a&&$(a,o,l),this.act(l,function(v,h,b){return a&&S(a,arguments),r.remove(this,o,i,v,h,l,b,a)})},close:function(n,i){i()},native:function(n,i){i()}},u=m(e,t,d);function f(n){let i=t.debug&&{msg:n[0],meta:n[2],start:Date.now()};return i&&y.push(i),i}function $(n,i,c){return n.apistart=Date.now(),n.ctx=i,n.apimsg=c,n}function S(n,i){return n.apiend=Date.now(),n.err=i[0],n.res=i[1],n.apimeta=i[2],n}return{name:d.name,tag:u.tag,exports:{makeApiMsg:p,msglog:y}}}function w(t,e){return t.entity(e.zone,e.base,e.name).canon$()}return g.defaults={debug:!1,apimsg:{aim:"req",on:"entity",q:(t,e)=>t.q,ent:(t,e)=>t.ent,save:(t,e)=>e.cmd==="save"?"entity":void 0,load:(t,e)=>e.cmd==="load"?"entity":void 0,list:(t,e)=>e.cmd==="list"?"entity":void 0,remove:(t,e)=>e.cmd==="remove"?"entity":void 0,store:(t,e)=>e.store,name:(t,e)=>e.name,base:(t,e)=>e.base,zone:(t,e)=>e.zone},prepareCtx:(t,e)=>{e=e||{};let m=t.q;e.store=m.store$!==!1,delete m.store$,e.cmd=t.cmd;let s=t.ent||t.qent;if(s){if(s.canon$)Object.assign(e,s.canon$({object:!0}));else if(s.entity$){let r=s.entity$.split("/");Object.assign(e,{zone:r[0]==="-"?null:r[0],base:r[1]==="-"?null:r[1],name:r[2]==="-"?null:r[2]})}}return e},handleResponse:{any:function(t,e,m,s,r,y,p,d){if(d&&(d.end=Date.now()),s)return m(s);if(y.load==="entity"&&(r==null||r.ok==null))return m(null);if(r&&r.ok&&r.item){let u=[e.zone,e.base,e.name],f=t.entity(...u);return m(f.clone$().data$(r.item))}else{let u=r&&r.err;return u=u||new Error(`BrowserStore: ${e.cmd} ${w(t,e)}: unknown error`),m(u)}},list:function(t,e,m,s,r,y,p,d){if(d&&(d.end=Date.now()),console.log("BS-LIST-RES",r,s),s&&m(s),r&&r.ok&&r.list){let u=[e.zone,e.base,e.name],f=t.entity(...u),$=r.list.map(S=>f.clone$().data$(S));d&&(d.end=Date.now()),m($)}else{let u=r&&r.err;u=u||new Error(`BrowserStore: ${e.cmd} ${w(t,e)}: unknown list error`),m(u)}}}},Object.defineProperty(g,"name",{value:"BrowserStore"}),g});
//# sourceMappingURL=browser-store.umd.js.map
